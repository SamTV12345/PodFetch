FROM node:latest as ui-builder

WORKDIR /app
COPY ./ui/ ./
RUN  npm install && npm run build


FROM library/rust:slim-buster as builder

USER root

WORKDIR /app/src

COPY --from=ui-builder /app/dist /app/src/static

ADD Cargo.toml .
ADD static ./static
ADD migrations ./migrations
ADD src ./src
RUN cargo build --release


FROM library/ubuntu:latest
WORKDIR /app/


COPY --from=builder /app/src/target/release/podgrabv2 /app/podgrabv2
COPY --from=builder /app/src/migrations /app/migrations
COPY --from=ui-builder /app/dist /app/static

EXPOSE 8000
CMD ["./podgrabv2"]